# ADR-001: 采用领域驱动设计（DDD）

## 状态
已接受

## 背景
当前的v1系统采用传统的分层架构，业务逻辑分散在各个service中，导致：
- 业务规则难以理解和维护
- 代码重复和不一致
- 测试困难，特别是业务逻辑测试
- 新功能开发需要修改多个地方

## 决策
我们决定在v2中采用领域驱动设计（DDD）方法，将系统重构为：
- **领域层（Domain）**：包含核心业务逻辑，与框架和基础设施无关
- **应用层（Application）**：协调领域对象完成用例
- **基础设施层（Infrastructure）**：技术实现细节
- **接口层（Interface）**：外部接口适配

## 理由
1. **业务逻辑集中**：所有业务规则都在领域层，易于理解和维护
2. **可测试性**：领域对象是纯粹的业务逻辑，易于单元测试
3. **灵活性**：技术选型的变更不会影响业务逻辑
4. **团队协作**：清晰的边界有助于团队并行开发

## 后果
### 正面影响
- 业务逻辑更清晰，新人更容易理解系统
- 测试覆盖率提升，特别是业务逻辑测试
- 系统更容易扩展和修改
- 可以逐步迁移，降低风险

### 负面影响
- 初期开发成本较高
- 需要团队学习DDD概念
- 代码量可能增加（但可维护性提升）

## 实施细节
1. **实体（Entity）**：Message、User、Conversation
2. **值对象（Value Object）**：MessageContent、LarkIds、ChatPermissions
3. **领域服务（Domain Service）**：MessageRuleEngine、AIService
4. **仓储接口（Repository）**：定义在领域层，实现在基础设施层
5. **领域事件（Domain Event）**：MessageReceived、UserMentioned等
# 自动部署系统

本文档介绍了Inner Bot Server项目的自动部署系统的设置和使用方法。

## 原理

此自动部署系统基于定时轮询机制，定期检查代码仓库是否有更新，如果发现更新则自动执行部署流程。

## 功能特点

1. 定时检查代码更新（每3分钟一次）
2. 自动执行生产环境部署
3. 带有锁机制，防止多个部署任务同时运行
4. 详细的日志记录
5. 超时控制，防止部署任务卡死
6. 自动记录每次部署的变更内容
7. 智能部署 - 只更新有代码变更的服务，提高部署效率
8. 飞书通知 - 部署结果自动发送至飞书群聊

## 设置步骤

### 1. 确保日志目录存在

首先，运行以下命令创建必要的日志目录：

```bash
./scripts/ensure_dirs.sh
```

该命令需要sudo权限来创建日志目录。

### 2. 配置飞书通知

在项目根目录的`.env`文件中添加以下配置（如果文件不存在，请创建它）：

```bash
# 部署通知Webhook URL
DEPLOY_WEBHOOK_URL=https://open.feishu.cn/open-apis/bot/v2/hook/your-webhook-token
```

请将`your-webhook-token`替换为您的飞书机器人实际webhook地址。

### 3. 设置自动部署定时任务

运行以下命令设置自动部署定时任务：

```bash
make auto-deploy-setup
```

这将添加一个crontab任务，每3分钟检查一次代码更新并执行部署。

### 4. 验证设置

检查crontab是否正确设置：

```bash
crontab -l | grep auto_deploy
```

应该能看到类似以下内容：

```bash
*/3 * * * * /path/to/your/project/scripts/auto_deploy.sh >> /var/log/inner_bot_server/cron.log 2>&1
```

## 手动触发部署

如果需要手动触发部署（不等待定时任务），可以直接运行：

```bash
./scripts/auto_deploy.sh
```

## 日志查看

自动部署系统会生成以下几个日志文件：

1. **主日志**：`/var/log/inner_bot_server/auto_deploy.log`
   - 包含每次部署检查的详细记录

2. **定时任务日志**：`/var/log/inner_bot_server/cron.log`
   - 包含cron任务的执行情况

3. **部署历史记录**：`/var/log/inner_bot_server/deploy_history.log`
   - 简要记录每次成功部署的时间

## 故障排除

1. **部署失败**
   - 检查日志文件获取详细错误信息
   - 确保服务器可以访问代码仓库
   - 确保有足够权限执行部署命令

2. **定时任务未执行**
   - 检查crontab是否正确设置
   - 检查服务器的cron服务是否运行

3. **部署超时**
   - 检查网络状况
   - 检查服务器资源使用情况
   - 考虑增加超时时间（在auto_deploy.sh脚本中修改TIMEOUT变量）

## 安全考虑

自动部署系统运行在服务器本地，不需要接收外部请求，符合安全要求。但请确保：

1. 脚本文件权限适当设置，防止未授权访问
2. 日志文件权限正确，防止信息泄露
3. 定期审查部署日志，检查是否有异常行为

## 部署策略

自动部署系统采用智能部署策略，只更新有代码变更的服务：

1. **选择性构建** - 只构建发生变更的服务镜像
2. **增量更新** - 基础服务（如数据库、缓存）仅在配置变更时才会重新创建
3. **应用服务更新** - 应用服务会自动检测变更并更新

这种策略可以显著减少部署时间和资源消耗，特别是在大型项目中。

## 飞书通知

自动部署系统会在以下情况发送飞书通知：

1. **部署成功**：包含版本更新信息和详细变更记录
2. **部署失败**：包含错误信息和退出代码
3. **部署超时**：提醒管理员检查服务器状态

通知示例：

```
✅ 服务已部署成功！
从版本 a1b2c3d 更新到 e4f5g6h

📝 变更内容:
e4f5g6h - 修复了用户登录bug (开发者, 2小时前)
b3d4e5f - 添加了新功能 (开发者, 3小时前)
```

如需禁用飞书通知，可以在`.env`文件中移除`DEPLOY_WEBHOOK_URL`变量。

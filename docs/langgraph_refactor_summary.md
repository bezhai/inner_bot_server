# LangGraph é‡æ„æ–¹æ¡ˆæ¦‚è§ˆ

## ğŸ¯ é‡æ„ç›®æ ‡

å°† ai-service çš„ `/chat/sse` æ¥å£ä»ä¼ ç»Ÿçš„çº¿æ€§å¤„ç†æ¨¡å¼é‡æ„ä¸ºåŸºäº LangGraph çš„å›¾å·¥ä½œæµæ¶æ„ï¼Œå®ç°ï¼š

- âœ… **å®Œå…¨å…¼å®¹** - ä¿æŒç°æœ‰æ¥å£å’Œè¾“å‡ºæ ¼å¼ä¸å˜
- âœ… **åŠ¨æ€æ¨¡å‹** - æ”¯æŒè¿è¡Œæ—¶æ¨¡å‹åˆ‡æ¢å’Œé…ç½®
- âœ… **æµå¼è¾“å‡º** - ä¿æŒ 0.5s ç¼“å­˜å’Œç´¯ç§¯å†…å®¹æœºåˆ¶
- âœ… **å·¥å…·è°ƒç”¨** - é›†æˆç°æœ‰å·¥å…·ç³»ç»Ÿ
- âœ… **å¯æ‰©å±•æ€§** - ä¸ºæœªæ¥å¤æ‚å·¥ä½œæµå¥ å®šåŸºç¡€

## ğŸ“Š æ¶æ„å¯¹æ¯”

### å½“å‰æ¶æ„
```
æ¶ˆæ¯æ¥æ”¶ â†’ ä¸Šä¸‹æ–‡æ„å»º â†’ AIç”Ÿæˆ â†’ å·¥å…·è°ƒç”¨ â†’ æµå¼è¿”å›
```

### é‡æ„åæ¶æ„
```
åˆå§‹åŒ– â†’ æç¤ºè¯ç”Ÿæˆ â†’ æ¨¡å‹è°ƒç”¨ â†’ å·¥å…·æ‰§è¡Œ â†’ è¾“å‡ºå¤„ç† â†’ æ¸…ç†
  â†“         â†“           â†“        â†“        â†“         â†“
çŠ¶æ€ç®¡ç†   åŠ¨æ€æ³¨å…¥    æµå¼å¤„ç†   å¹¶è¡Œæ”¯æŒ   ç‰¹æ®Šå¤„ç†   èµ„æºé‡Šæ”¾
```

## ğŸ—ï¸ æ ¸å¿ƒæ¨¡å—

### 1. çŠ¶æ€ç®¡ç† (`state.py`)
```python
class ChatGraphState(TypedDict):
    message_id: str
    context: MessageContext
    model_config: Dict[str, Any]
    accumulated_content: str
    current_chunks: List[ChatStreamChunk]
    # ... å…¶ä»–çŠ¶æ€å­—æ®µ
```

### 2. å›¾èŠ‚ç‚¹ (`nodes.py`)
- **initialize_node** - åˆå§‹åŒ–ä¸Šä¸‹æ–‡å’ŒåŠ é”
- **prompt_generation_node** - åŠ¨æ€æç¤ºè¯ç”Ÿæˆ
- **model_call_node** - æ¨¡å‹è°ƒç”¨å’Œæµå¼å¤„ç†
- **tool_execution_node** - å·¥å…·è°ƒç”¨å’Œç»“æœå¤„ç†
- **output_processing_node** - ç‰¹æ®Šè¾“å‡ºå¤„ç†
- **cleanup_node** - èµ„æºæ¸…ç†å’Œè§£é”

### 3. æµå¼å¤„ç† (`streaming.py`)
- ç»´æŠ¤ 0.5s ç¼“å­˜æœºåˆ¶
- ç´¯ç§¯å†…å®¹è€Œéå·®é‡å†…å®¹
- å…¼å®¹ç°æœ‰ ChatStreamChunk æ ¼å¼

### 4. æ¨¡å‹æœåŠ¡ (`models.py`)
- å¤ç”¨ç°æœ‰ OpenAI å®¢æˆ·ç«¯ç¼“å­˜
- æ”¯æŒåŠ¨æ€æ¨¡å‹åˆ‡æ¢
- å¤„ç†å·¥å…·è°ƒç”¨å’Œæµå¼å“åº”

## ğŸ“‹ å®æ–½è®¡åˆ’

| é˜¶æ®µ | æ—¶é—´ | ä»»åŠ¡ | äº¤ä»˜ç‰© |
|------|------|------|--------|
| é˜¶æ®µ1 | 3-4å¤© | æ ¸å¿ƒæ¶æ„æ­å»º | å›¾å®šä¹‰ã€èŠ‚ç‚¹å®ç°ã€çŠ¶æ€ç®¡ç† |
| é˜¶æ®µ2 | 1-2å¤© | æç¤ºè¯é‡æ„ | LangChain æ¨¡æ¿ã€æç¤ºè¯è¿ç§» |
| é˜¶æ®µ3 | 2-3å¤© | æœåŠ¡å±‚é‡æ„ | æ–°ChatServiceã€æ¥å£é€‚é… |
| é˜¶æ®µ4 | 2-3å¤© | æµ‹è¯•éªŒè¯ | å•å…ƒæµ‹è¯•ã€é›†æˆæµ‹è¯•ã€æ€§èƒ½æµ‹è¯• |
| é˜¶æ®µ5 | 2-3å¤© | ç°åº¦å‘å¸ƒ | åŒæ ˆè¿è¡Œã€ç›‘æ§ã€åé¦ˆæ”¶é›† |
| é˜¶æ®µ6 | 1-2å¤© | å…¨é‡åˆ‡æ¢ | ä»£ç æ¸…ç†ã€æ–‡æ¡£æ›´æ–° |

## ğŸ”„ è¿ç§»ç­–ç•¥

### åŒæ ˆè¿è¡ŒæœŸ
```python
# é…ç½®æ§åˆ¶
enable_langgraph: bool = False
langgraph_fallback: bool = True

# ç°åº¦æ§åˆ¶
def should_use_langgraph(message_id: str) -> bool:
    return hash(message_id) % 100 < 10  # 10% æµé‡
```

### å…¼å®¹æ€§ä¿è¯
- ä¿æŒ `/chat/sse` æ¥å£ä¸å˜
- ä¿æŒæµå¼è¾“å‡ºæ ¼å¼ä¸å˜
- ä¿æŒç‰¹æ®Šå¤„ç†é€»è¾‘ä¸å˜ï¼ˆcontent_filterã€length ç­‰ï¼‰
- ä¿æŒå·¥å…·è°ƒç”¨æœºåˆ¶ä¸å˜

## ğŸ“ˆ é¢„æœŸæ”¶ç›Š

### çŸ­æœŸæ”¶ç›Š
- ä»£ç ç»“æ„æ›´æ¸…æ™°
- é”™è¯¯å¤„ç†æ›´å®Œå–„
- è°ƒè¯•ä½“éªŒæ›´å¥½
- çŠ¶æ€ç®¡ç†æ›´è§„èŒƒ

### é•¿æœŸæ”¶ç›Š
- æ”¯æŒå¤æ‚å¤šæ­¥æ¨ç†
- æ”¯æŒå¹¶è¡Œå·¥å…·è°ƒç”¨
- æ”¯æŒæ¡ä»¶åˆ†æ”¯é€»è¾‘
- æ”¯æŒå·¥ä½œæµå¯è§†åŒ–

## âš ï¸ å…³é”®é£é™©

### æŠ€æœ¯é£é™©
- **æ€§èƒ½å¼€é”€** - LangGraph å¯èƒ½å¸¦æ¥é¢å¤–å¼€é”€
- **å…¼å®¹æ€§** - è¾“å‡ºæ ¼å¼çš„å¾®å°å·®å¼‚
- **ä¾èµ–ç¨³å®šæ€§** - æ–°ä¾èµ–åº“çš„ç¨³å®šæ€§

### åº”å¯¹æªæ–½
- è¯¦ç»†æ€§èƒ½æµ‹è¯•å’ŒåŸºå‡†å¯¹æ¯”
- å…¨é¢å›å½’æµ‹è¯•å’Œç”¨æˆ·éªŒæ”¶æµ‹è¯•
- é”å®šä¾èµ–ç‰ˆæœ¬å’Œå‡†å¤‡é™çº§æ–¹æ¡ˆ

## ğŸ“Š ç›‘æ§æŒ‡æ ‡

### å…³é”®æŒ‡æ ‡
- å“åº”æ—¶é—´ï¼ˆP50/P95/P99ï¼‰
- é”™è¯¯ç‡å’ŒæˆåŠŸç‡
- èµ„æºä½¿ç”¨ç‡ï¼ˆCPU/å†…å­˜ï¼‰
- å·¥å…·è°ƒç”¨æˆåŠŸç‡

### å‘Šè­¦é˜ˆå€¼
- å“åº”æ—¶é—´ > 5ç§’
- é”™è¯¯ç‡ > 5%
- CPU ä½¿ç”¨ç‡ > 80%
- å†…å­˜ä½¿ç”¨ç‡ > 80%

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. ä¾èµ–å®‰è£…
```bash
cd main-server
uv add langgraph>=0.0.40 langchain>=0.1.0 langchain-openai>=0.1.0
```

### 2. ç›®å½•åˆ›å»º
```bash
mkdir -p ai-service/app/services/chat/langgraph
mkdir -p ai-service/app/services/chat/prompts
mkdir -p ai-service/app/services/chat/legacy
```

### 3. è¿è¡Œæµ‹è¯•
```bash
cd ai-service
python -m pytest tests/test_langgraph_chat.py -v
```

### 4. å¯ç”¨LangGraph
```python
# åœ¨ app/config/config.py ä¸­
enable_langgraph: bool = True
```

## ğŸ“š å‚è€ƒèµ„æ–™

- [LangGraph å®˜æ–¹æ–‡æ¡£](https://langchain-ai.github.io/langgraph/)
- [LangChain æç¤ºè¯æ¨¡æ¿](https://python.langchain.com/docs/modules/model_io/prompts/)
- [è¯¦ç»†å®æ–½æ–¹æ¡ˆ](./langgraph_refactor_plan.md)

---

**æ³¨æ„ï¼š** æœ¬æ–¹æ¡ˆå¤„äºè§„åˆ’é˜¶æ®µï¼Œå®æ–½å‰è¯·å……åˆ†è¯„ä¼°é£é™©å¹¶è¿›è¡ŒæŠ€æœ¯é¢„ç ”ã€‚
